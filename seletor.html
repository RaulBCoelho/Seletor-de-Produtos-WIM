<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Seletor WIM</title>
<style>
body { font-family: Arial, sans-serif; padding: 20px; }
.pergunta { border: 1px solid #ccc; padding: 12px; margin-bottom: 12px; }
.resultado { border: 2px solid #000; padding: 15px; margin-top: 20px; background-color: #f5f5f5;}
button { padding: 8px 12px; margin-top: 10px; }
</style>
</head>
<body>

<h1>Seletor de Produto – WIM</h1>
<div id="app"></div>
<button onclick="resetar()">Limpar tudo</button>

<script>
let respostas = {};
let dataGlobal = null;

fetch("rules_wim.json")
  .then(r => r.json())
  .then(data => { dataGlobal = data; iniciar(data); })
  .catch(err => console.error("Erro ao carregar JSON:", err));

function iniciar(data) {
  const app = document.getElementById("app");
  app.innerHTML = "";
  
  data.fluxo.forEach(p => {
    if (!condicao(p.condicao)) return;

    const div = document.createElement("div");
    div.className = "pergunta";
    div.innerHTML = `<b>${p.pergunta}</b><br><br>`;

    // BOOLEAN
    if (p.tipo === "boolean") {
      ["Sim","Não"].forEach(v=>{
        const i = document.createElement("input");
        i.type="radio";
        i.name=p.id;
        i.value=v==="Sim";
        i.checked=respostas[p.id]===(v==="Sim");
        i.onchange=()=>{ respostas[p.id]=i.value==="true"; iniciar(data); };
        div.append(i," "+v,document.createElement("br"));
      });
    }

    // SELECT
    if(p.tipo==="opcao"){
      const s=document.createElement("select");
      s.innerHTML=`<option value="">Selecione</option>`;
      p.opcoes.forEach(o=>s.add(new Option(o,o)));
      s.value=respostas[p.id]||"";
      s.onchange=()=>{ respostas[p.id]=s.value; iniciar(data); };
      div.appendChild(s);
    }

    // MULTI CHECKBOX
    if(p.tipo==="opcao_multipla"){
      respostas[p.id] ||= [];
      p.opcoes.forEach(o=>{
        if(p.id==="fieldbus" && respostas["quantidade_io"]>4 && o!=="Nenhum") return;
        const i=document.createElement("input");
        i.type="checkbox";
        i.checked=respostas[p.id].includes(o);
        i.onchange=()=>{
          i.checked ? respostas[p.id].push(o) : respostas[p.id]=respostas[p.id].filter(v=>v!==o);
          iniciar(data);
        };
        div.append(i," "+o,document.createElement("br"));
      });
    }

    // NUMBER
    if(p.tipo==="number"){
      const i=document.createElement("input");
      i.type="number";
      i.value=respostas[p.id]??"";
      i.onchange=()=>{ respostas[p.id]=Number(i.value); iniciar(data); };
      div.appendChild(i);
    }

    app.appendChild(div);
  });

  // botão gerar resultado
  const lastPergunta = data.fluxo[data.fluxo.length-1];
  if(lastPergunta && Object.keys(respostas).length>=data.fluxo.length){
    const btn=document.createElement("button");
    btn.textContent="Finalizar";
    btn.onclick=()=>{ mostrarResumo(data); };
    app.appendChild(btn);
  }
}

function condicao(c){
  if(!c) return true;
  return Object.keys(c).every(k=>respostas[k]===c[k]);
}

function resetar(){
  respostas={};
  if(dataGlobal) iniciar(dataGlobal);
  const resDiv = document.querySelector(".resultado");
  if(resDiv) resDiv.remove();
}

function mostrarResumo(data){
  const app=document.getElementById("app");
  let resDiv=document.querySelector(".resultado");
  if(!resDiv){
    resDiv=document.createElement("div");
    resDiv.className="resultado";
    app.appendChild(resDiv);
  }
  resDiv.innerHTML="<h3>Resumo do Painel</h3>";

  // painel selecionado
  const painel=data.paineis.find(p=>p.codigo===respostas["painel"]);
  if(!painel){ resDiv.innerHTML+="<p>Selecione o painel corretamente</p>"; return; }

  let resumo=`Nome: ${painel.nome}<br>Código: ${painel.codigo}<br>`;
  
  // calculando metros de cabo
  const metrosPainelEquip=Number(respostas["metros_cabo"]||0);
  let quantidadeCaixas=0;
  let metrosTotalB=metrosPainelEquip; // balança
  let metrosTotalT=metrosPainelEquip; // tacometro

  if(respostas["quantidade_celulas"]>4){
    // se mais de uma caixa
    const caixas=Math.ceil(respostas["quantidade_celulas"]/4);
    quantidadeCaixas=caixas;
    metrosTotalB += caixas*Number(respostas["metros_cx"]||0);
    metrosTotalT += caixas*Number(respostas["metros_cx"]||0);
  }

  resumo+=`Cabo Balança: ${metrosTotalB} m, código: ${respostas["area_classificada"]?"6207719":"6207717"}<br>`;
  resumo+=`Cabo Tacômetro: ${metrosTotalT} m, código: ${respostas["area_classificada"]?"5023332":"3405110"}<br>`;

  // tacometro
  let tacometroCodigo="";
  if(respostas["area_classificada"]){ tacometroCodigo="5015367"; }
  else{ tacometroCodigo=respostas["tacometro"]==="Gerador de pulsos"?"5600013":"5100264"; }

  resumo+=`Tacômetro código: ${tacometroCodigo}<br>`;

  // caixa de junção
  if(respostas["modelo_caixa"]){
    let cxJunCodigo=respostas["modelo_caixa"]==="Inox"?"6053134":"6302178";
    let cxPasCodigo=respostas["modelo_caixa"]==="Inox"?"6076468":"6219739";
    let qtdCelulas=respostas["quantidade_celulas"];
    let qtdJun=0, qtdPas=0;
    if(qtdCelulas<=4){ qtdJun=1; qtdPas=0; }
    else if(qtdCelulas<=8){ qtdJun=2; qtdPas=1; }
    else if(qtdCelulas<=12){ qtdJun=3; qtdPas=1; }
    else if(qtdCelulas<=16){ qtdJun=4; qtdPas=1; }

    resumo+=`Caixa de Junção (${respostas["modelo_caixa"]}): ${qtdJun}x ${cxJunCodigo}<br>`;
    if(qtdPas>0) resumo+=`Caixa de Passagem (${respostas["modelo_caixa"]}): ${qtdPas}x ${cxPasCodigo}<br>`;
  }

  resDiv.innerHTML+=resumo;
}
</script>
</body>
</html>
